{% extends "base.html" %}

{% block title %}Textgenerator - BewerbungsManager{% endblock %}

{% block head %}
<!-- Quill.js Rich Text Editor -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<style>
    /* Rich Text Editor Styles */
    .ql-container {
        border: 1px solid var(--border-color) !important;
        border-top: none !important;
        border-radius: 0 0 var(--radius-md) var(--radius-md);
        font-family: var(--font-sans) !important;
        background: var(--bg-secondary);
    }
    
    .ql-editor {
        min-height: 500px;
        color: var(--text-primary);
        font-size: 0.95rem;
        line-height: 1.7;
    }

    .ql-toolbar {
        background: var(--bg-tertiary) !important;
        border-color: var(--border-color) !important;
        border-radius: var(--radius-md) var(--radius-md) 0 0 !important;
    }

    .ql-snow .ql-stroke { stroke: var(--text-secondary) !important; }
    .ql-snow .ql-fill { fill: var(--text-secondary) !important; }
    .ql-snow .ql-picker { color: var(--text-secondary) !important; }

    /* PDF Preview Styles */
    .pdf-preview-container {
        background: var(--bg-tertiary);
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
        overflow: hidden;
    }
    
    .margin-settings {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
    }
    
    .margin-group {
        display: flex;
        align-items: center;
        gap: 0.35rem;
    }
    
    .margin-input {
        width: 50px;
        height: 26px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm);
        color: var(--text-primary);
        text-align: center;
        font-size: 0.8rem;
    }

    .margin-preset-btn {
        padding: 0.2rem 0.5rem;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm);
        color: var(--text-secondary);
        font-size: 0.75rem;
        cursor: pointer;
    }

    .margin-preset-btn.active {
        border-color: var(--accent-primary);
        color: var(--accent-primary);
        background: rgba(0, 212, 170, 0.1);
    }

    /* Tabs */
    .editor-tabs {
        display: flex;
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
    }
    
    .editor-tab {
        padding: 0.75rem 1.5rem;
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        font-weight: 500;
        border-bottom: 2px solid transparent;
    }
    
    .editor-tab.active {
        color: var(--accent-primary);
        border-bottom-color: var(--accent-primary);
    }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .generator-layout {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 1.5rem;
    }

    /* Placeholder Tags */
    .placeholder-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .placeholder-tag {
        padding: 0.25rem 0.75rem;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm);
        font-size: 0.8rem;
        font-family: var(--font-mono);
        color: var(--accent-primary);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .placeholder-tag:hover {
        background: var(--bg-hover);
        border-color: var(--accent-primary);
    }

    @media (max-width: 1000px) {
        .generator-layout { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title"><i class="bi bi-file-earmark-text"></i> Textgenerator</h1>
</div>

<div class="generator-layout">
    <!-- Left: Inputs -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title"><i class="bi bi-pencil"></i> Eingaben</h2>
        </div>
        <form id="generatorForm" class="p-3">
            <div class="form-group mb-3">
                <label class="form-label">Unternehmen</label>
                <input type="text" name="company" class="form-control" placeholder="z.B. Beispiel GmbH" value="{{ application.company_name if application else '' }}">
            </div>
            <div class="form-group mb-3">
                <label class="form-label">Stellenbezeichnung</label>
                <input type="text" name="job_title" class="form-control" placeholder="z.B. Projektmanager" value="{{ application.job_title if application else '' }}">
            </div>
            <div class="form-group mb-3">
                <label class="form-label">Unternehmensadresse</label>
                <textarea name="company_address" class="form-control" rows="3" placeholder="Straße\nPLZ Ort"></textarea>
            </div>
            <div class="form-group mb-3">
                <label class="form-label">Ansprechpartner</label>
                <input type="text" name="contact_person" class="form-control" placeholder="z.B. Frau Müller">
            </div>
            <div class="form-group mb-3">
                <label class="form-label">Datum</label>
                <input type="date" name="date" class="form-control" value="{{ now().strftime('%Y-%m-%d') }}">
            </div>
            <hr class="my-4" style="border-color: var(--border-color);">
            <h3 class="h6 mb-3">Ihre Daten</h3>
            <div class="form-group mb-2">
                <label class="form-label small">Name</label>
                <input type="text" name="your_name" class="form-control form-control-sm" value="{{ user_settings.your_name or '' }}">
            </div>
            <div class="form-group mb-2">
                <label class="form-label small">E-Mail</label>
                <input type="email" name="your_email" class="form-control form-control-sm" value="{{ user_settings.your_email or '' }}">
            </div>
            <div class="form-group mb-2">
                <label class="form-label small">Adresse</label>
                <textarea name="your_address" class="form-control form-control-sm" rows="2">{{ user_settings.your_address or '' }}</textarea>
            </div>
            <div class="form-group mb-2">
                <label class="form-label small">Telefon</label>
                <input type="tel" name="your_phone" class="form-control form-control-sm" value="{{ user_settings.your_phone or '' }}">
            </div>
        </form>
    </div>

    <!-- Right: Editor & Preview -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h2 class="card-title"><i class="bi bi-file-text"></i> Anschreiben</h2>
            <div class="d-flex gap-2">
                <select id="templateSelect" class="form-select form-select-sm" style="width: auto;" onchange="loadTemplate(this.value)">
                    <option value="">-- Vorlage wählen --</option>
                    {% for t in templates %}<option value="{{ t.id }}">{{ t.name }}</option>{% endfor %}
                </select>
                <a href="{{ url_for('template_new') }}" class="btn btn-secondary btn-sm"><i class="bi bi-plus"></i></a>
            </div>
        </div>

        <div class="p-3">
            <!-- Placeholders -->
            <div class="placeholder-tags">
                {% for placeholder in placeholders %}
                <span class="placeholder-tag" onclick="insertPlaceholder('{{ placeholder }}')">{{ placeholder }}</span>
                {% endfor %}
            </div>

            <div class="editor-tabs">
                <button id="tab-editor" class="editor-tab active" onclick="switchTab('editor')"><i class="bi bi-pencil-square"></i> Editor</button>
                <button id="tab-preview" class="editor-tab" onclick="switchTab('preview')"><i class="bi bi-eye"></i> PDF Vorschau</button>
            </div>

            <div id="editorTab" class="tab-content active">
                <div id="templateEditor"></div>
            </div>

            <div id="previewTab" class="tab-content">
                <div class="pdf-preview-container">
                    <div class="margin-settings">
                        <div class="margin-group">
                            <span class="small text-muted">Oben:</span>
                            <input type="number" id="marginTop" class="margin-input" value="27" onchange="updatePDFPreview()">
                        </div>
                        <div class="margin-group">
                            <span class="small text-muted">Unten:</span>
                            <input type="number" id="marginBottom" class="margin-input" value="25" onchange="updatePDFPreview()">
                        </div>
                        <div class="margin-group">
                            <span class="small text-muted">Links:</span>
                            <input type="number" id="marginLeft" class="margin-input" value="25" onchange="updatePDFPreview()">
                        </div>
                        <div class="margin-group">
                            <span class="small text-muted">Rechts:</span>
                            <input type="number" id="marginRight" class="margin-input" value="20" onchange="updatePDFPreview()">
                        </div>
                        <div class="ms-auto d-flex gap-1">
                            <button id="preset-din5008" class="margin-preset-btn active" onclick="setMarginPreset('din5008')">DIN 5008</button>
                            <button id="preset-schmal" class="margin-preset-btn" onclick="setMarginPreset('schmal')">Schmal</button>
                        </div>
                    </div>
                    <div style="height: 800px; background: #525659; display: flex; justify-content: center; align-items: center;">
                        <iframe id="pdfFrame" style="width: 100%; height: 100%; border: none;"></iframe>
                    </div>
                </div>
            </div>

            <div class="mt-3 d-flex gap-2 flex-wrap">
                <button class="btn btn-primary" onclick="generateText()"><i class="bi bi-lightning"></i> Generieren</button>
                <button class="btn btn-secondary" onclick="copyToClipboard()"><i class="bi bi-clipboard"></i> Kopieren</button>
                <button class="btn btn-primary" onclick="exportPDF()"><i class="bi bi-file-pdf"></i> PDF Download</button>
                {% if application %}
                <button class="btn btn-secondary" onclick="saveLetter()"><i class="bi bi-save"></i> Speichern</button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="toast" style="position: fixed; bottom: 2rem; right: 2rem; padding: 1rem; border-radius: var(--radius-md); display: none; z-index: 9999; background: var(--bg-secondary); border: 1px solid var(--accent-primary); box-shadow: var(--shadow-card);">
    <span id="toastMessage"></span>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<script>
// Initialize Quill
const quill = new Quill('#templateEditor', {
    theme: 'snow',
    placeholder: 'Text hier eingeben...',
    modules: {
        toolbar: [
            ['bold', 'italic', 'underline'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            [{ 'align': [] }],
            ['clean']
        ]
    }
});

function switchTab(tab) {
    document.querySelectorAll('.editor-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    if (tab === 'editor') {
        document.getElementById('tab-editor').classList.add('active');
        document.getElementById('editorTab').classList.add('active');
    } else {
        document.getElementById('tab-preview').classList.add('active');
        document.getElementById('previewTab').classList.add('active');
        updatePDFPreview();
    }
}

function insertPlaceholder(p) {
    const range = quill.getSelection(true);
    quill.insertText(range.index, p);
}

function getMargins() {
    return {
        top: parseInt(document.getElementById('marginTop').value) || 27,
        bottom: parseInt(document.getElementById('marginBottom').value) || 25,
        left: parseInt(document.getElementById('marginLeft').value) || 25,
        right: parseInt(document.getElementById('marginRight').value) || 20
    };
}

function setMarginPreset(preset) {
    document.querySelectorAll('.margin-preset-btn').forEach(b => b.classList.remove('active'));
    if (preset === 'din5008') {
        document.getElementById('preset-din5008').classList.add('active');
        document.getElementById('marginTop').value = 27;
        document.getElementById('marginBottom').value = 25;
        document.getElementById('marginLeft').value = 25;
        document.getElementById('marginRight').value = 20;
    } else {
        document.getElementById('preset-schmal').classList.add('active');
        document.getElementById('marginTop').value = 20;
        document.getElementById('marginBottom').value = 20;
        document.getElementById('marginLeft').value = 20;
        document.getElementById('marginRight').value = 15;
    }
    updatePDFPreview();
}

let currentPdfUrl = null;

async function updatePDFPreview() {
    const iframe = document.getElementById('pdfFrame');
    const data = getFormData();
    const htmlContent = quill.root.innerHTML;
    const plainText = quill.getText().trim();
    
    // Wenn fast kein Text da ist, Platzhalter zeigen
    if (plainText.length < 1) {
        iframe.srcdoc = '<body style="background:#525659;color:white;display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;margin:0">Bitte Text im Editor eingeben...</body>';
        return;
    }

    try {
        iframe.srcdoc = '<body style="background:#525659;color:white;display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;margin:0">PDF wird geladen...</body>';
        
        const response = await fetch('/api/preview-pdf', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ...data, html_content: htmlContent, body_text: plainText, margins: getMargins() })
        });
        
        if (!response.ok) throw new Error('Serverfehler');
        
        const blob = await response.blob();
        if (currentPdfUrl) URL.revokeObjectURL(currentPdfUrl);
        currentPdfUrl = URL.createObjectURL(blob);
        iframe.src = currentPdfUrl;
        iframe.removeAttribute('srcdoc');
    } catch (e) {
        iframe.srcdoc = `<body style="background:#525659;color:#ff6b6b;display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;margin:0">Fehler beim Laden der Vorschau: ${e.message}</body>`;
    }
}

function getFormData() {
    const f = new FormData(document.getElementById('generatorForm'));
    const d = {};
    f.forEach((v, k) => d[k] = v);
    return d;
}

async function loadTemplate(id) {
    if (!id) return;
    const r = await fetch('/api/templates/' + id);
    const res = await r.json();
    if (res.success) {
        quill.root.innerHTML = res.template.content.replace(/\n/g, '<br>');
        showToast('Vorlage geladen');
    }
}

async function generateText() {
    showToast('Generiere...', 'info');
    try {
        const response = await fetch('/api/generate-text', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ...getFormData(), current_content: quill.root.innerHTML })
        });
        const res = await response.json();
        if (res.success) {
            quill.root.innerHTML = res.text.replace(/\n/g, '<br>');
            showToast('Text bereit!');
        } else {
            showToast('Fehler: ' + res.error);
        }
    } catch (e) {
        showToast('Systemfehler');
    }
}

function copyToClipboard() {
    navigator.clipboard.writeText(quill.getText()).then(() => showToast('Kopiert!'));
}

async function exportPDF() {
    showToast('PDF wird erstellt...');
    try {
        const response = await fetch('/api/export-pdf', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ...getFormData(), html_content: quill.root.innerHTML, body_text: quill.getText(), margins: getMargins() })
        });
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'Bewerbung.pdf';
        a.click();
        showToast('Download gestartet');
    } catch (e) {
        showToast('Fehler beim Export');
    }
}

function showToast(m, type = 'success') {
    const t = document.getElementById('toast');
    document.getElementById('toastMessage').textContent = m;
    t.style.display = 'block';
    setTimeout(() => t.style.display = 'none', 3000);
}
</script>
{% endblock %}
